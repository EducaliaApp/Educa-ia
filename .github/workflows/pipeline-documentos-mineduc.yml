name: Sync Datos MINEDUC - Base de Conocimientos

on:
  schedule:
    # Ejecutar los domingos a las 2 AM UTC (11 PM Chile)
    - cron: '0 2 * * 0'

  workflow_dispatch:
    # Permitir ejecuci√≥n manual
    inputs:
      force_full_sync:
        description: 'Forzar sincronizaci√≥n completa (ignora cache)'
        required: false
        default: false
        type: boolean
      slack_notification:
        description: 'Enviar notificaci√≥n por Slack'
        required: false
        default: false
        type: boolean
      force_rubric_extraction:
        description: 'Forzar extracci√≥n de r√∫bricas con IA'
        required: false
        default: false
        type: boolean

env:
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
  COHERE_API_KEY: ${{ secrets.COHERE_API_KEY }}
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

permissions:
  models: read
  contents: read

jobs:
  extraccion-documentos:
    name: Extraer Documentos Oficiales
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      has_changes: ${{ steps.check_nuevos.outputs.has_changes }}
      nuevos: ${{ steps.check_nuevos.outputs.nuevos }}
      actualizados: ${{ steps.check_nuevos.outputs.actualizados }}

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.40.x

      - name: Invocar Edge Function de monitoreo
        id: monitor
        run: |
          response=$(curl -X POST \
            "${{ secrets.SUPABASE_URL }}/functions/v1/monitor-documentos-oficiales" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"force": ${{ github.event.inputs.force_full_sync || false }}}')

          echo "response=$response" >> $GITHUB_OUTPUT
          echo "### üìä Reporte de Monitoreo" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
          echo "$response" | jq '.' >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Verificar documentos nuevos
        id: check_nuevos
        run: |
          response='${{ steps.monitor.outputs.response }}'

          # Verificar si hay error en la respuesta
          if echo "$response" | jq -e '.error' > /dev/null; then
            echo "‚ùå Error en Edge Function: $(echo "$response" | jq -r '.error')"
            echo "nuevos=0" >> $GITHUB_OUTPUT
            echo "actualizados=0" >> $GITHUB_OUTPUT
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Extraer valores con defaults
          nuevos=$(echo "$response" | jq -r '.reporte.documentos_nuevos // 0')
          actualizados=$(echo "$response" | jq -r '.reporte.documentos_actualizados // 0')
          
          # Validar que son n√∫meros
          if ! [[ "$nuevos" =~ ^[0-9]+$ ]]; then nuevos=0; fi
          if ! [[ "$actualizados" =~ ^[0-9]+$ ]]; then actualizados=0; fi

          echo "nuevos=$nuevos" >> $GITHUB_OUTPUT
          echo "actualizados=$actualizados" >> $GITHUB_OUTPUT

          if [ "$nuevos" -gt 0 ] || [ "$actualizados" -gt 0 ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Notificar cambios por Slack
        if: steps.check_nuevos.outputs.has_changes == 'true' && github.event.inputs.slack_notification == 'true'
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "üîî Nuevos documentos MINEDUC detectados",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üìö Actualizaci√≥n de Documentos MINEDUC"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Documentos nuevos:* ${{ steps.check_nuevos.outputs.nuevos }}\n*Documentos actualizados:* ${{ steps.check_nuevos.outputs.actualizados }}"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "Ver en GitHub"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

  etl-extract:
    name: "FASE 1: Extract - Descargar PDFs"
    runs-on: ubuntu-latest
    needs: extraccion-documentos
    if: always() && (needs.extraccion-documentos.outputs.has_changes == 'true' || github.event.inputs.force_full_sync == 'true')
    timeout-minutes: 15
    outputs:
      downloaded: ${{ steps.download.outputs.count }}

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar dependencias
        run: pip install -r scripts/pipeline-document-mineduc/requirements.txt

      - name: Descargar PDFs
        id: download
        run: |
          output=$(python scripts/pipeline-document-mineduc/fase1_extract.py 2>&1)
          echo "$output"
          downloaded=$(echo "$output" | grep -o "Descargados: [0-9]\+" | grep -o "[0-9]\+" || echo "0")
          echo "count=$downloaded" >> $GITHUB_OUTPUT
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

  etl-transform:
    name: "FASE 2: Transform - Extraer Texto"
    runs-on: ubuntu-latest
    needs: etl-extract
    if: needs.etl-extract.outputs.downloaded > 0
    timeout-minutes: 20
    outputs:
      transformed: ${{ steps.transform.outputs.count }}

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar dependencias
        run: |
          pip install -r scripts/pipeline-document-mineduc/requirements.txt
          sudo apt-get update && sudo apt-get install -y tesseract-ocr tesseract-ocr-spa

      - name: Extraer texto
        id: transform
        run: |
          output=$(python scripts/pipeline-document-mineduc/fase2_transform.py 2>&1)
          echo "$output"
          transformed=$(echo "$output" | grep -o "Transformados: [0-9]\+" | grep -o "[0-9]\+" || echo "0")
          echo "count=$transformed" >> $GITHUB_OUTPUT
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          COHERE_API_KEY: ${{ secrets.COHERE_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

  etl-load:
    name: "FASE 3: Load - Generar Embeddings"
    runs-on: ubuntu-latest
    needs: etl-transform
    if: needs.etl-transform.outputs.transformed > 0
    timeout-minutes: 20
    outputs:
      loaded: ${{ steps.load.outputs.count }}
      tokens: ${{ steps.load.outputs.tokens }}
      cost: ${{ steps.load.outputs.cost }}

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar dependencias
        run: pip install -r scripts/pipeline-document-mineduc/requirements.txt

      - name: Generar embeddings y cargar
        id: load
        run: |
          output=$(python scripts/pipeline-document-mineduc/fase3_load.py 2>&1)
          echo "$output"
          loaded=$(echo "$output" | grep -o "Cargados: [0-9]\+" | grep -o "[0-9]\+" || echo "0")
          tokens=$(echo "$output" | grep -o "Tokens: [0-9,]\+" | grep -o "[0-9,]\+" | tr -d ',' || echo "0")
          cost=$(echo "$output" | grep -o "Costo: \$[0-9.]\+" | grep -o "[0-9.]\+" || echo "0")
          echo "count=$loaded" >> $GITHUB_OUTPUT
          echo "tokens=$tokens" >> $GITHUB_OUTPUT
          echo "cost=$cost" >> $GITHUB_OUTPUT
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          COHERE_API_KEY: ${{ secrets.COHERE_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

  validar-calidad:
    name: "FASE 4: Validar Calidad"
    runs-on: ubuntu-latest
    needs: etl-load
    if: needs.etl-load.outputs.loaded > 0
    timeout-minutes: 10
    outputs:
      validated: ${{ steps.validate.outputs.count }}
      quality: ${{ steps.validate.outputs.quality }}

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar dependencias
        run: pip install -r scripts/pipeline-document-mineduc/requirements.txt

      - name: Validar calidad
        id: validate
        run: |
          output=$(python scripts/pipeline-document-mineduc/fase4_validacion_calidad.py 2>&1)
          echo "$output"
          validated=$(echo "$output" | grep -o "Aprobados: [0-9]\+" | grep -o "[0-9]\+" || echo "0")
          quality=$(echo "$output" | grep -o "Calidad: [0-9.]\+%" | grep -o "[0-9.]\+" || echo "0")
          echo "count=$validated" >> $GITHUB_OUTPUT
          echo "quality=$quality" >> $GITHUB_OUTPUT
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  optimizar-embeddings:
    name: "FASE 5: Optimizar √çndices"
    runs-on: ubuntu-latest
    needs: validar-calidad
    if: needs.validar-calidad.outputs.validated > 0
    timeout-minutes: 10

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar dependencias
        run: pip install supabase python-dotenv

      - name: Optimizar √≠ndices
        run: python scripts/pipeline-document-mineduc/fase5_optimize.py
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  registrar-metricas:
    name: "FASE 6: Registrar M√©tricas"
    runs-on: ubuntu-latest
    needs: [etl-extract, etl-transform, etl-load, validar-calidad, optimizar-embeddings]
    if: always()
    timeout-minutes: 5

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar dependencias
        run: pip install supabase python-dotenv

      - name: Registrar m√©tricas
        run: |
          python scripts/pipeline-document-mineduc/fase6_metrics.py \
            --downloaded "${{ needs.etl-extract.outputs.downloaded || 0 }}" \
            --transformed "${{ needs.etl-transform.outputs.transformed || 0 }}" \
            --loaded "${{ needs.etl-load.outputs.loaded || 0 }}" \
            --validated "${{ needs.validar-calidad.outputs.validated || 0 }}" \
            --quality "${{ needs.validar-calidad.outputs.quality || 0 }}" \
            --tokens "${{ needs.etl-load.outputs.tokens || 0 }}" \
            --cost "${{ needs.etl-load.outputs.cost || 0 }}" \
            --workflow-id "${{ github.run_id }}"
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

      - name: Resumen final
        run: |
          echo "### üìä Resumen Pipeline ETL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Fase | Resultado |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Extract | ${{ needs.etl-extract.outputs.downloaded || 0 }} descargados |" >> $GITHUB_STEP_SUMMARY
          echo "| Transform | ${{ needs.etl-transform.outputs.transformed || 0 }} transformados |" >> $GITHUB_STEP_SUMMARY
          echo "| Load | ${{ needs.etl-load.outputs.loaded || 0 }} cargados |" >> $GITHUB_STEP_SUMMARY
          echo "| Validaci√≥n | ${{ needs.validar-calidad.outputs.validated || 0 }} validados (${{ needs.validar-calidad.outputs.quality || 0 }}%) |" >> $GITHUB_STEP_SUMMARY
          echo "| Tokens | ${{ needs.etl-load.outputs.tokens || 0 }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Costo | \$${{ needs.etl-load.outputs.cost || 0 }} USD |" >> $GITHUB_STEP_SUMMARY



      - name: Resultados de validaci√≥n
        run: |
          echo "### ‚úÖ Validaci√≥n de Datos RAG" >> $GITHUB_STEP_SUMMARY
          if [ -f validation-results.md ]; then
            cat validation-results.md >> $GITHUB_STEP_SUMMARY
          else
            echo "No hay reporte de validaci√≥n disponible" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fallar si hay errores cr√≠ticos
        if: steps.validate.outputs.critical_errors > 0
        run: |
          echo "‚ùå Se encontraron ${{ steps.validate.outputs.critical_errors }} errores cr√≠ticos"
          exit 1

  update-metrics:
    name: Actualizar M√©tricas RAG
    runs-on: ubuntu-latest
    needs: [etl-extract, etl-transform, etl-load, validar-calidad, optimizar-embeddings, registrar-metricas]
    if: always()

    steps:
      - name: Registrar m√©tricas en Supabase
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          curl -X POST \
            "${{ secrets.SUPABASE_URL }}/rest/v1/metricas_pipeline_rag" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=representation" \
            -d '{
              "fecha": "'$(date -I)'",
              "documentos_monitoreados": ${{ needs.extraccion-documentos.outputs.nuevos || 0 }},
              "documentos_procesados": ${{ needs.etl-load.outputs.loaded || 0 }},
              "chunks_validados": ${{ needs.validar-calidad.outputs.validated || 0 }},
              "errores_criticos": 0,
              "workflow_run_id": "${{ github.run_id }}"
            }'

  notify-completion:
    name: Notificar Completado
    runs-on: ubuntu-latest
    needs: [extraccion-documentos, etl-extract, etl-transform, etl-load, validar-calidad, update-metrics]
    if: always()

    steps:
      - name: Determinar estado
        id: status
        run: |
          if [ "${{ needs.validar-calidad.result }}" == "failure" ]; then
            echo "status=‚ùå Fall√≥" >> $GITHUB_OUTPUT
            echo "color=#dc2626" >> $GITHUB_OUTPUT
          elif [ "${{ needs.etl-load.result }}" == "failure" ]; then
            echo "status=‚ö†Ô∏è Completado con errores" >> $GITHUB_OUTPUT
            echo "color=#f59e0b" >> $GITHUB_OUTPUT
          else
            echo "status=‚úÖ Exitoso" >> $GITHUB_OUTPUT
            echo "color=#16a34a" >> $GITHUB_OUTPUT
          fi

      - name: Enviar notificaci√≥n final
        if: ${{ github.event.inputs.slack_notification == 'true' }}
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "attachments": [
                {
                  "color": "${{ steps.status.outputs.color }}",
                  "blocks": [
                    {
                      "type": "header",
                      "text": {
                        "type": "plain_text",
                        "text": "${{ steps.status.outputs.status }} Sync R√∫bricas MINEDUC"
                      }
                    },
                    {
                      "type": "section",
                      "fields": [
                        {
                          "type": "mrkdwn",
                          "text": "*Documentos Nuevos:*\n${{ needs.extraccion-documentos.outputs.nuevos || 0 }}"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Documentos Actualizados:*\n${{ needs.extraccion-documentos.outputs.actualizados || 0 }}"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Documentos Cargados:*\n${{ needs.etl-load.outputs.loaded || 0 }}"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Documentos Validados:*\n${{ needs.validar-calidad.outputs.validated || 0 }}"
                        }
                      ]
                    },
                    {
                      "type": "context",
                      "elements": [
                        {
                          "type": "mrkdwn",
                          "text": "Triggered by: ${{ github.event_name }} | Run: <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|#${{ github.run_number }}>"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
