name: Deploy Edge Functions

on:
  pull_request:
    branches:
      - main
      - production
    types: [closed]
    paths:
      - 'supabase/functions/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - production
          - staging
        default: 'staging'
      function_name:
        description: 'Function name (leave empty to deploy all)'
        required: false
        type: string

env:
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
  SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}

jobs:
  # ============================================
  # JOB 1: Deploy Edge Functions
  # ============================================
  deploy-functions:
    name: Deploy Supabase Edge Functions
    runs-on: ubuntu-latest
    # Only run on merged PRs, direct pushes to main/production, or manual dispatch
    if: |
      github.event_name == 'push' || 
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link Supabase Project
        run: |
          supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_ID }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: List Edge Functions
        run: |
          echo "ðŸ“‹ Available Edge Functions:"
          ls -la supabase/functions/
          echo ""
          echo "ðŸ” Checking which functions need deployment..."

      - name: Deploy Specific Function
        if: github.event.inputs.function_name != ''
        run: |
          FUNCTION_NAME="${{ github.event.inputs.function_name }}"
          echo "ðŸš€ Deploying function: $FUNCTION_NAME"
          
          if [ ! -d "supabase/functions/$FUNCTION_NAME" ]; then
            echo "âŒ Function $FUNCTION_NAME not found!"
            exit 1
          fi
          
          supabase functions deploy $FUNCTION_NAME --no-verify-jwt
          echo "âœ… Function $FUNCTION_NAME deployed successfully!"
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Deploy All Functions
        if: github.event.inputs.function_name == ''
        run: |
          echo "ðŸš€ Deploying all Edge Functions..."
          
          # Get list of function directories (exclude shared and _shared)
          FUNCTIONS=$(find supabase/functions -maxdepth 1 -type d ! -name functions ! -name shared ! -name _shared -exec basename {} \;)
          
          # Counter for deployment status
          DEPLOYED=0
          FAILED=0
          
          for FUNCTION in $FUNCTIONS; do
            # Skip if not a directory or if it's a utility folder
            if [ ! -f "supabase/functions/$FUNCTION/index.ts" ]; then
              echo "â­ï¸  Skipping $FUNCTION (no index.ts found)"
              continue
            fi
            
            echo ""
            echo "ðŸ“¦ Deploying: $FUNCTION"
            
            if supabase functions deploy $FUNCTION --no-verify-jwt; then
              echo "  âœ… $FUNCTION deployed successfully"
              DEPLOYED=$((DEPLOYED + 1))
            else
              echo "  âŒ $FUNCTION deployment failed"
              FAILED=$((FAILED + 1))
            fi
          done
          
          echo ""
          echo "ðŸ“Š Deployment Summary:"
          echo "  âœ… Successfully deployed: $DEPLOYED"
          echo "  âŒ Failed: $FAILED"
          
          if [ $FAILED -gt 0 ]; then
            echo ""
            echo "âš ï¸  Some functions failed to deploy. Please check the logs above."
            exit 1
          fi
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Verify Deployment
        run: |
          echo "ðŸ” Verifying Edge Functions deployment..."
          supabase functions list || echo "âš ï¸  Could not list functions"
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Test Edge Functions (Optional)
        if: success()
        run: |
          echo "ðŸ§ª Running basic health checks..."
          echo "Edge Functions deployed. Manual testing recommended."
          echo "Visit Supabase Dashboard â†’ Edge Functions to test endpoints."

      - name: Deployment Summary
        if: success()
        run: |
          echo "âœ… Edge Functions deployment completed successfully!"
          echo ""
          echo "ðŸ“‹ Next steps:"
          echo "  1. Test functions in Supabase Dashboard"
          echo "  2. Verify function logs for any runtime errors"
          echo "  3. Update frontend if function signatures changed"

      - name: Notify on Failure
        if: failure()
        run: |
          echo "âŒ Edge Functions deployment failed!"
          echo "âš ï¸  Please check the logs above for details."
          echo "ðŸ’¡ Common issues:"
          echo "  - Missing dependencies in function"
          echo "  - Syntax errors in TypeScript"
          echo "  - Invalid deno.json configuration"
          echo "  - Network connectivity issues"

  # ============================================
  # JOB 2: Update Documentation (Optional)
  # ============================================
  update-docs:
    name: Update Function Documentation
    runs-on: ubuntu-latest
    needs: deploy-functions
    if: success()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate Function List
        run: |
          echo "ðŸ“ Generating Edge Functions documentation..."
          echo "# Deployed Edge Functions" > /tmp/functions-list.md
          echo "" >> /tmp/functions-list.md
          echo "Last updated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> /tmp/functions-list.md
          echo "" >> /tmp/functions-list.md
          
          # List all functions
          FUNCTIONS=$(find supabase/functions -maxdepth 1 -type d ! -name functions ! -name shared ! -name _shared -exec basename {} \;)
          
          for FUNCTION in $FUNCTIONS; do
            if [ -f "supabase/functions/$FUNCTION/index.ts" ]; then
              echo "- \`$FUNCTION\`" >> /tmp/functions-list.md
            fi
          done
          
          echo ""
          cat /tmp/functions-list.md

      - name: Documentation Summary
        run: |
          echo "âœ… Function list generated"
          echo "ðŸ’¡ Consider updating project documentation with deployed functions"
