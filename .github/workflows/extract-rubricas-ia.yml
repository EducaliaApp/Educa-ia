name: Extraer RÃºbricas con IA

on:
  schedule:
    - cron: '0 3 * * 0'  # Domingos 3 AM UTC
  workflow_dispatch:
    inputs:
      force_extraction:
        description: 'Forzar extracciÃ³n completa'
        required: false
        default: false
        type: boolean

env:
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

permissions:
  contents: read

jobs:
  obtener-documentos-rubricas:
    name: "Obtener Documentos RÃºbricas"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      count: ${{ steps.check.outputs.count }}

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar dependencias
        run: pip install supabase python-dotenv

      - name: Verificar documentos pendientes
        id: check
        run: |
          output=$(python scripts/rubricas/check_pending.py 2>&1)
          echo "$output"
          count=$(echo "$output" | grep -o "Pendientes: [0-9]\+" | grep -o "[0-9]\+" || echo "0")
          echo "count=$count" >> $GITHUB_OUTPUT

  extraer-rubricas-ia:
    name: "Extraer RÃºbricas con IA"
    runs-on: ubuntu-latest
    needs: obtener-documentos-rubricas
    if: needs.obtener-documentos-rubricas.outputs.count > 0 || github.event.inputs.force_extraction == 'true'
    timeout-minutes: 45
    outputs:
      extracted: ${{ steps.extract.outputs.count }}

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar dependencias
        run: pip install openai google-generativeai anthropic supabase python-dotenv requests

      - name: Extraer rÃºbricas
        id: extract
        run: |
          output=$(python scripts/rubricas/extract_rubricas.py 2>&1)
          echo "$output"
          extracted=$(echo "$output" | grep -o "ExtraÃ­das: [0-9]\+" | grep -o "[0-9]\+" || echo "0")
          echo "count=$extracted" >> $GITHUB_OUTPUT

  validar-calidad-rubricas:
    name: "Validar Calidad RÃºbricas"
    runs-on: ubuntu-latest
    needs: extraer-rubricas-ia
    if: needs.extraer-rubricas-ia.outputs.extracted > 0
    timeout-minutes: 10
    outputs:
      validated: ${{ steps.validate.outputs.count }}
      quality: ${{ steps.validate.outputs.quality }}

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar dependencias
        run: pip install supabase python-dotenv

      - name: Validar calidad
        id: validate
        run: |
          output=$(python scripts/rubricas/validate_rubricas.py 2>&1)
          echo "$output"
          validated=$(echo "$output" | grep -o "Validadas: [0-9]\+" | grep -o "[0-9]\+" || echo "0")
          quality=$(echo "$output" | grep -o "Calidad: [0-9.]\\+%" | grep -o "[0-9.]\\+" || echo "0")
          echo "count=$validated" >> $GITHUB_OUTPUT
          echo "quality=$quality" >> $GITHUB_OUTPUT

  optimizar-embeddings-rubricas:
    name: "Optimizar Embeddings RÃºbricas"
    runs-on: ubuntu-latest
    needs: validar-calidad-rubricas
    if: needs.validar-calidad-rubricas.outputs.validated > 0
    timeout-minutes: 10

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar dependencias
        run: pip install supabase python-dotenv

      - name: Optimizar Ã­ndices
        run: python scripts/rubricas/optimize_indices.py

  registrar-metricas-rubricas:
    name: "Registrar MÃ©tricas"
    runs-on: ubuntu-latest
    needs: [obtener-documentos-rubricas, extraer-rubricas-ia, validar-calidad-rubricas, optimizar-embeddings-rubricas]
    if: always()
    timeout-minutes: 5

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar dependencias
        run: pip install supabase python-dotenv

      - name: Registrar mÃ©tricas
        run: |
          python scripts/rubricas/register_metrics.py \
            --pending "${{ needs.obtener-documentos-rubricas.outputs.count || 0 }}" \
            --extracted "${{ needs.extraer-rubricas-ia.outputs.extracted || 0 }}" \
            --validated "${{ needs.validar-calidad-rubricas.outputs.validated || 0 }}" \
            --quality "${{ needs.validar-calidad-rubricas.outputs.quality || 0 }}" \
            --workflow-id "${{ github.run_id }}"

      - name: Resumen final
        run: |
          echo "### ðŸ“Š Resumen ExtracciÃ³n RÃºbricas" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Fase | Resultado |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Documentos pendientes | ${{ needs.obtener-documentos-rubricas.outputs.count || 0 }} |" >> $GITHUB_STEP_SUMMARY
          echo "| RÃºbricas extraÃ­das | ${{ needs.extraer-rubricas-ia.outputs.extracted || 0 }} |" >> $GITHUB_STEP_SUMMARY
          echo "| RÃºbricas validadas | ${{ needs.validar-calidad-rubricas.outputs.validated || 0 }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Calidad promedio | ${{ needs.validar-calidad-rubricas.outputs.quality || 0 }}% |" >> $GITHUB_STEP_SUMMARY
