name: Test Pipeline MLOps

on:
  pull_request:
    paths:
      - 'scripts/pipeline-document-mineduc/**'
      - 'scripts/rubricas/**'
  push:
    branches: [main, develop]
    paths:
      - 'scripts/pipeline-document-mineduc/**'
      - 'scripts/rubricas/**'
  workflow_dispatch:

jobs:
  test-etl-pipeline:
    name: Test ETL Pipeline
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar dependencias
        run: |
          pip install -r scripts/pipeline-document-mineduc/requirements.txt
          pip install pytest pytest-cov pytest-mock

      - name: Ejecutar tests ETL
        run: |
          cd scripts/pipeline-document-mineduc
          python -m pytest test_pipeline.py -v --cov=. --cov-report=term-missing

      - name: Verificar sintaxis scripts
        run: |
          python -m py_compile scripts/pipeline-document-mineduc/fase*.py
          python -m py_compile scripts/pipeline-document-mineduc/validacion_calidad.py
          python -m py_compile scripts/pipeline-document-mineduc/mlops_pipeline.py

  test-rubricas-pipeline:
    name: Test Rúbricas Pipeline
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar dependencias
        run: |
          pip install supabase python-dotenv openai google-generativeai anthropic
          pip install pytest pytest-cov pytest-mock

      - name: Ejecutar tests rúbricas
        run: |
          cd scripts/rubricas
          python -m pytest test_rubricas.py -v --cov=. --cov-report=term-missing

      - name: Verificar sintaxis scripts
        run: |
          python -m py_compile scripts/rubricas/*.py

  integration-test:
    name: Integration Test
    runs-on: ubuntu-latest
    needs: [test-etl-pipeline, test-rubricas-pipeline]
    timeout-minutes: 5

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Test imports
        run: |
          pip install -r scripts/pipeline-document-mineduc/requirements.txt
          python -c "from scripts.pipeline_document_monitor import mlops_pipeline; print('✅ Imports OK')"

      - name: Resumen tests
        run: |
          echo "### ✅ Tests Completados" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ETL Pipeline: ${{ needs.test-etl-pipeline.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Rúbricas Pipeline: ${{ needs.test-rubricas-pipeline.result }}" >> $GITHUB_STEP_SUMMARY
