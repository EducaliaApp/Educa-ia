name: Sync R√∫bricas MINEDUC

on:
  schedule:
    # Ejecutar los domingos a las 2 AM UTC (11 PM Chile)
    - cron: '0 2 * * 0'

  workflow_dispatch:
    # Permitir ejecuci√≥n manual
    inputs:
      force_full_sync:
        description: 'Forzar sincronizaci√≥n completa (ignora cache)'
        required: false
        default: false
        type: boolean
      slack_notification:
        description: 'Enviar notificaci√≥n por Slack'
        required: false
        default: false
        type: boolean
      force_rubric_extraction:
        description: 'Forzar extracci√≥n de r√∫bricas con IA'
        required: false
        default: false
        type: boolean

env:
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

permissions:
  models: read
  contents: read

jobs:
  monitor-documentos:
    name: Monitorear Documentos Oficiales
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      has_changes: ${{ steps.check_nuevos.outputs.has_changes }}
      nuevos: ${{ steps.check_nuevos.outputs.nuevos }}
      actualizados: ${{ steps.check_nuevos.outputs.actualizados }}

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.40.x

      - name: Invocar Edge Function de monitoreo
        id: monitor
        run: |
          response=$(curl -X POST \
            "${{ secrets.SUPABASE_URL }}/functions/v1/monitor-documentos-oficiales" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"force": ${{ github.event.inputs.force_full_sync || false }}}')

          echo "response=$response" >> $GITHUB_OUTPUT
          echo "### üìä Reporte de Monitoreo" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
          echo "$response" | jq '.' >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Verificar documentos nuevos
        id: check_nuevos
        run: |
          response='${{ steps.monitor.outputs.response }}'

          # Verificar si hay error en la respuesta
          if echo "$response" | jq -e '.error' > /dev/null; then
            echo "‚ùå Error en Edge Function: $(echo "$response" | jq -r '.error')"
            echo "nuevos=0" >> $GITHUB_OUTPUT
            echo "actualizados=0" >> $GITHUB_OUTPUT
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Extraer valores con defaults
          nuevos=$(echo "$response" | jq -r '.reporte.documentos_nuevos // 0')
          actualizados=$(echo "$response" | jq -r '.reporte.documentos_actualizados // 0')
          
          # Validar que son n√∫meros
          if ! [[ "$nuevos" =~ ^[0-9]+$ ]]; then nuevos=0; fi
          if ! [[ "$actualizados" =~ ^[0-9]+$ ]]; then actualizados=0; fi

          echo "nuevos=$nuevos" >> $GITHUB_OUTPUT
          echo "actualizados=$actualizados" >> $GITHUB_OUTPUT

          if [ "$nuevos" -gt 0 ] || [ "$actualizados" -gt 0 ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Notificar cambios por Slack
        if: steps.check_nuevos.outputs.has_changes == 'true' && github.event.inputs.slack_notification == 'true'
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "üîî Nuevos documentos MINEDUC detectados",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üìö Actualizaci√≥n de Documentos MINEDUC"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Documentos nuevos:* ${{ steps.check_nuevos.outputs.nuevos }}\n*Documentos actualizados:* ${{ steps.check_nuevos.outputs.actualizados }}"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "Ver en GitHub"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

  process-documents:
    name: Procesar Documentos PDF
    runs-on: ubuntu-latest
    needs: monitor-documentos
    if: always() && (needs.monitor-documentos.outputs.has_changes == 'true' || github.event.inputs.force_full_sync == 'true' || github.event_name == 'workflow_dispatch')
    timeout-minutes: 30
    outputs:
      processed: ${{ steps.count_processed.outputs.count }}

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar dependencias
        run: |
          pip install --upgrade pip
          pip install supabase python-dotenv PyMuPDF openai requests
          # Instalar Tesseract para OCR
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr tesseract-ocr-spa
          pip install pytesseract Pillow

      - name: Procesar documentos PDF
        id: process
        run: |
          set +e  # No fallar inmediatamente en errores
          
          echo "üîç Verificando variables de entorno..."
          if [ -z "$SUPABASE_URL" ]; then echo "‚ùå SUPABASE_URL no configurada"; exit 1; fi
          if [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then echo "‚ùå SUPABASE_SERVICE_ROLE_KEY no configurada"; exit 1; fi
          
          echo "üêç Verificando instalaci√≥n de Python..."
          python --version
          pip list | grep -E "(supabase|openai|PyMuPDF|python-dotenv)"

          echo "üìÅ Verificando archivos..."
          ls -la scripts/pipeline-document-monitor/

          echo "üöÄ Ejecutando procesador..."
          output=$(python scripts/pipeline-document-monitor/01-document-processor.py --auto --verbose 2>&1)
          exit_code=$?

          echo "$output"
          echo "Exit code: $exit_code"

          if [ $exit_code -eq 0 ]; then
            processed=$(echo "$output" | grep -o "[0-9]\+ documentos procesados exitosamente" | grep -o "[0-9]\+" || echo "0")
          else
            echo "‚ùå Script fall√≥ con c√≥digo $exit_code"
            processed=0
          fi

          echo "processed_count=$processed" >> $GITHUB_OUTPUT
          echo "Documentos procesados: $processed"

          # No fallar el job si no hay documentos que procesar
          exit 0
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Contar documentos procesados
        id: count_processed
        run: |
          processed=${{ steps.process.outputs.processed_count || 0 }}
          if ! [[ "$processed" =~ ^[0-9]+$ ]]; then processed=0; fi
          echo "count=$processed" >> $GITHUB_OUTPUT
          echo "Documentos procesados: $processed"

  extract-rubricas:
    name: Extraer R√∫bricas con IA
    runs-on: ubuntu-latest
    needs: [monitor-documentos, process-documents]
    if: always() && (needs.process-documents.outputs.processed > 0 || github.event.inputs.force_rubric_extraction == 'true')
    timeout-minutes: 45
    outputs:
      extracted: ${{ steps.count_extracted.outputs.count }}

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar dependencias
        run: |
          pip install --upgrade pip
          pip install anthropic openai supabase python-dotenv requests

      - name: Ejecutar extracci√≥n de r√∫bricas
        id: extract
        run: |
          set +e  # No fallar inmediatamente
          
          output=$(python scripts/pipeline-document-monitor/rubric-extractor.py --auto --verbose 2>&1)
          exit_code=$?
          
          echo "$output"
          echo "Exit code: $exit_code"
          
          # Buscar r√∫bricas extra√≠das en el output
          extracted=$(echo "$output" | grep -o "Procesamiento completado: [0-9]\+ r√∫bricas extra√≠das" | grep -o "[0-9]\+" || echo "0")
          
          # Si no encontr√≥ el patr√≥n normal, buscar el mensaje de APIs no disponibles
          if [ "$extracted" = "0" ] && echo "$output" | grep -q "APIs no disponibles"; then
            echo "‚ÑπÔ∏è APIs no disponibles, pero el pipeline contin√∫a"
            extracted=0
          fi
          
          echo "extracted_count=$extracted" >> $GITHUB_OUTPUT
          echo "R√∫bricas extra√≠das: $extracted"
          
          # Siempre salir con c√≥digo 0 para no fallar el pipeline
          exit 0
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COHERE_API_KEY: ${{ secrets.COHERE_API_KEY }}

      - name: Contar r√∫bricas extra√≠das
        id: count_extracted
        run: |
          extracted=${{ steps.extract.outputs.extracted_count || 0 }}
          if ! [[ "$extracted" =~ ^[0-9]+$ ]]; then extracted=0; fi
          echo "count=$extracted" >> $GITHUB_OUTPUT
          echo "R√∫bricas extra√≠das: $extracted"

  validate-data:
    name: Validar Calidad de Datos
    runs-on: ubuntu-latest
    needs: [process-documents, extract-rubricas]
    if: always()
    timeout-minutes: 15
    outputs:
      critical_errors: ${{ steps.validate.outputs.critical_errors }}
      validated: ${{ steps.validate.outputs.validated }}
      quality_score: ${{ steps.validate.outputs.quality_score }}

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.40.x

      - name: Ejecutar validaci√≥n de chunks
        id: validate
        run: |
          deno run --allow-net --allow-env --allow-write scripts/validate-rag-data.ts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
      - name: Subir reporte de validaci√≥n
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: validation-report
          path: validation-results.md
          retention-days: 30

  optimize-embeddings:
    name: Optimizar Embeddings
    runs-on: ubuntu-latest
    needs: validate-data
    if: needs.validate-data.outputs.critical_errors == '0'
    timeout-minutes: 20

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.40.x

      - name: Optimizar √≠ndices vectoriales
        run: |
          deno run --allow-net --allow-env scripts/optimize-vector-indices.ts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

  generate-summary:
    name: Generar Resumen Final
    runs-on: ubuntu-latest
    needs: [monitor-documentos, process-documents, extract-rubricas, validate-data]
    if: always()
    timeout-minutes: 5

    steps:
      - name: Generar resumen del pipeline
        run: |
          echo "## üìä Resumen del Pipeline ETL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Etapa | Estado | Resultados |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|------------|" >> $GITHUB_STEP_SUMMARY
          echo "| üì° Monitoreo | ${{ needs.monitor-documentos.result }} | ${{ needs.monitor-documentos.outputs.nuevos }} nuevos, ${{ needs.monitor-documentos.outputs.actualizados }} actualizados |" >> $GITHUB_STEP_SUMMARY
          echo "| üìÑ Procesamiento | ${{ needs.process-documents.result }} | ${{ needs.process-documents.outputs.processed }} documentos |" >> $GITHUB_STEP_SUMMARY
          echo "| ü§ñ Extracci√≥n IA | ${{ needs.extract-rubricas.result }} | ${{ needs.extract-rubricas.outputs.extracted }} r√∫bricas |" >> $GITHUB_STEP_SUMMARY
          echo "| ‚úÖ Validaci√≥n | ${{ needs.validate-data.result }} | ${{ needs.validate-data.outputs.critical_errors }} errores cr√≠ticos |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Calidad de Datos:** ${{ needs.validate-data.outputs.quality_score }}%" >> $GITHUB_STEP_SUMMARY
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}


      - name: Publicar resultados de validaci√≥n
        run: |
          echo "### ‚úÖ Validaci√≥n de Datos RAG" >> $GITHUB_STEP_SUMMARY
          cat validation-results.md >> $GITHUB_STEP_SUMMARY

      - name: Fallar si hay errores cr√≠ticos
        if: steps.validate.outputs.critical_errors > 0
        run: |
          echo "‚ùå Se encontraron ${{ steps.validate.outputs.critical_errors }} errores cr√≠ticos"
          exit 1

  update-metrics:
    name: Actualizar M√©tricas RAG
    runs-on: ubuntu-latest
    needs: [monitor-documentos, process-documents, extract-rubricas, validate-data]
    if: always()

    steps:
      - name: Registrar m√©tricas en Supabase
        run: |
          curl -X POST \
            "${{ secrets.SUPABASE_URL }}/rest/v1/metricas_pipeline_rag" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=representation" \
            -d '{
              "fecha": "'$(date -I)'",
              "documentos_monitoreados": ${{ needs.monitor-documentos.outputs.nuevos || 0 }},
              "documentos_procesados": ${{ needs.extract-rubricas.outputs.extracted || 0 }},
              "chunks_validados": ${{ needs.validate-data.outputs.validated || 0 }},
              "errores_criticos": ${{ needs.validate-data.outputs.critical_errors || 0 }},
              "workflow_run_id": "${{ github.run_id }}"
            }'

  notify-completion:
    name: Notificar Completado
    runs-on: ubuntu-latest
    needs: [monitor-documentos, process-documents, extract-rubricas, validate-data, update-metrics]
    if: always()

    steps:
      - name: Determinar estado
        id: status
        run: |
          if [ "${{ needs.validate-data.result }}" == "failure" ]; then
            echo "status=‚ùå Fall√≥" >> $GITHUB_OUTPUT
            echo "color=#dc2626" >> $GITHUB_OUTPUT
          elif [ "${{ needs.extract-rubricas.result }}" == "failure" ]; then
            echo "status=‚ö†Ô∏è Completado con errores" >> $GITHUB_OUTPUT
            echo "color=#f59e0b" >> $GITHUB_OUTPUT
          else
            echo "status=‚úÖ Exitoso" >> $GITHUB_OUTPUT
            echo "color=#16a34a" >> $GITHUB_OUTPUT
          fi

      - name: Enviar notificaci√≥n final
        if: ${{ github.event.inputs.slack_notification == 'true' }}
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "attachments": [
                {
                  "color": "${{ steps.status.outputs.color }}",
                  "blocks": [
                    {
                      "type": "header",
                      "text": {
                        "type": "plain_text",
                        "text": "${{ steps.status.outputs.status }} Sync R√∫bricas MINEDUC"
                      }
                    },
                    {
                      "type": "section",
                      "fields": [
                        {
                          "type": "mrkdwn",
                          "text": "*Documentos Nuevos:*\n${{ needs.monitor-documentos.outputs.nuevos || 0 }}"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Documentos Actualizados:*\n${{ needs.monitor-documentos.outputs.actualizados || 0 }}"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*R√∫bricas Extra√≠das:*\n${{ needs.extract-rubricas.outputs.extracted || 0 }}"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Errores Cr√≠ticos:*\n${{ needs.validate-data.outputs.critical_errors || 0 }}"
                        }
                      ]
                    },
                    {
                      "type": "context",
                      "elements": [
                        {
                          "type": "mrkdwn",
                          "text": "Triggered by: ${{ github.event_name }} | Run: <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|#${{ github.run_number }}>"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
